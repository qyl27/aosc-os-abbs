From fef36f2883b8b694f909c63bfc338c119317a7a6 Mon Sep 17 00:00:00 2001
From: Kexy Biscuit <kexybiscuit@aosc.io>
Date: Fri, 26 Jul 2024 08:29:50 +0800
Subject: [PATCH 18/31] [LA64] swiftshader.patch

https://github.com/AOSC-Dev/aosc-os-abbs/blob/c0cc5a4aab518bf24451de466fba520ea70ddc34/app-web/chromium/autobuild/patches/4001-loongarch64-swiftshader.patch

Co-authored-by: Jiajie Chen <c@jia.je>
---
 third_party/swiftshader/src/Reactor/BUILD.gn   |  6 +++++-
 .../linux/include/llvm/Config/AsmParsers.def   |  3 +++
 .../linux/include/llvm/Config/AsmPrinters.def  |  3 +++
 .../include/llvm/Config/Disassemblers.def      |  3 +++
 .../linux/include/llvm/Config/Targets.def      |  3 +++
 .../linux/include/llvm/Config/llvm-config.h    | 18 ++++++++++++++++++
 6 files changed, 35 insertions(+), 1 deletion(-)

diff --git a/third_party/swiftshader/src/Reactor/BUILD.gn b/third_party/swiftshader/src/Reactor/BUILD.gn
index 67dfeb0ec8..c9683912e7 100644
--- a/third_party/swiftshader/src/Reactor/BUILD.gn
+++ b/third_party/swiftshader/src/Reactor/BUILD.gn
@@ -307,7 +307,11 @@ if (supports_subzero) {
 
 if (supports_llvm) {
   swiftshader_source_set("swiftshader_llvm_reactor") {
-    llvm_dir = "../../third_party/llvm-10.0"
+    if (current_cpu == "loong64") {
+      llvm_dir = "../../third_party/llvm-16.0"
+    } else {
+      llvm_dir = "../../third_party/llvm-10.0"
+    }
 
     deps = [
       ":swiftshader_reactor_base",
diff --git a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/AsmParsers.def b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/AsmParsers.def
index 2af3e28e82..521454bdff 100644
--- a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/AsmParsers.def
+++ b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/AsmParsers.def
@@ -45,6 +45,9 @@ LLVM_ASM_PARSER(PowerPC)
 #if defined(__riscv)
 LLVM_ASM_PARSER(RISCV)
 #endif
+#if defined(__loongarch__)
+LLVM_ASM_PARSER(LoongArch)
+#endif
 
 
 #undef LLVM_ASM_PARSER
diff --git a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/AsmPrinters.def b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/AsmPrinters.def
index 2f675be26f..28eb68ec49 100644
--- a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/AsmPrinters.def
+++ b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/AsmPrinters.def
@@ -45,6 +45,9 @@ LLVM_ASM_PRINTER(PowerPC)
 #if defined(__riscv)
 LLVM_ASM_PRINTER(RISCV)
 #endif
+#if defined(__loongarch__)
+LLVM_ASM_PRINTER(LoongArch)
+#endif
 
 
 #undef LLVM_ASM_PRINTER
diff --git a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/Disassemblers.def b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/Disassemblers.def
index 80e3a1374d..26ff566ff6 100644
--- a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/Disassemblers.def
+++ b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/Disassemblers.def
@@ -45,6 +45,9 @@ LLVM_DISASSEMBLER(PowerPC)
 #if defined(__riscv)
 LLVM_DISASSEMBLER(RISCV)
 #endif
+#if defined(__loongarch__)
+LLVM_DISASSEMBLER(LoongArch)
+#endif
 
 
 #undef LLVM_DISASSEMBLER
diff --git a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/Targets.def b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/Targets.def
index d34b0eaee7..91e9c27781 100644
--- a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/Targets.def
+++ b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/Targets.def
@@ -44,6 +44,9 @@ LLVM_TARGET(PowerPC)
 #if defined(__riscv)
 LLVM_TARGET(RISCV)
 #endif
+#if defined(__loongarch__)
+LLVM_TARGET(LoongArch)
+#endif
 
 
 #undef LLVM_TARGET
diff --git a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/llvm-config.h b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/llvm-config.h
index d9cce40e4e..1be6ba9507 100644
--- a/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/llvm-config.h
+++ b/third_party/swiftshader/third_party/llvm-16.0/configs/linux/include/llvm/Config/llvm-config.h
@@ -47,6 +47,8 @@
 #define LLVM_DEFAULT_TARGET_TRIPLE "powerpc64le-unknown-linux-gnu"
 #elif defined(__riscv)
 #define LLVM_DEFAULT_TARGET_TRIPLE "riscv64-unknown-linux-gnu"
+#elif defined(__loongarch__)
+#define LLVM_DEFAULT_TARGET_TRIPLE "loongarch64-unknown-linux-gnu"
 #else
 #error "unknown architecture"
 #endif
@@ -76,6 +78,8 @@
 #define LLVM_HOST_TRIPLE "powerpc64le-unknown-linux-gnu"
 #elif defined(__riscv)
 #define LLVM_HOST_TRIPLE "riscv64-unknown-linux-gnu"
+#elif defined(__loongarch__)
+#define LLVM_HOST_TRIPLE "loongarch64-unknown-linux-gnu"
 #else
 #error "unknown architecture"
 #endif
@@ -95,6 +99,8 @@
 #define LLVM_NATIVE_ARCH PowerPC
 #elif defined(__riscv)
 #define LLVM_NATIVE_ARCH RISCV
+#elif defined(__loongarch__)
+#define LLVM_NATIVE_ARCH LoongArch
 #else
 #error "unknown architecture"
 #endif
@@ -114,6 +120,8 @@
 #define LLVM_NATIVE_ASMPARSER LLVMInitializePowerPCAsmParser
 #elif defined(__riscv)
 #define LLVM_NATIVE_ASMPARSER LLVMInitializeRISCVAsmParser
+#elif defined(__loongarch__)
+#define LLVM_NATIVE_ASMPARSER LLVMInitializeLoongArchAsmParser
 #else
 #error "unknown architecture"
 #endif
@@ -133,6 +141,8 @@
 #define LLVM_NATIVE_ASMPRINTER LLVMInitializePowerPCAsmPrinter
 #elif defined(__riscv)
 #define LLVM_NATIVE_ASMPRINTER LLVMInitializeRISCVAsmPrinter
+#elif defined(__loongarch__)
+#define LLVM_NATIVE_ASMPRINTER LLVMInitializeLoongArchAsmPrinter
 #else
 #error "unknown architecture"
 #endif
@@ -152,6 +162,8 @@
 #define LLVM_NATIVE_DISASSEMBLER LLVMInitializePowerPCDisassembler
 #elif defined(__riscv)
 #define LLVM_NATIVE_DISASSEMBLER LLVMInitializeRISCVDisassembler
+#elif defined(__loongarch__)
+#define LLVM_NATIVE_DISASSEMBLER LLVMInitializeLoongArchDisassembler
 #else
 #error "unknown architecture"
 #endif
@@ -171,6 +183,8 @@
 #define LLVM_NATIVE_TARGET LLVMInitializePowerPCTarget
 #elif defined(__riscv)
 #define LLVM_NATIVE_TARGET LLVMInitializeRISCVTarget
+#elif defined(__loongarch__)
+#define LLVM_NATIVE_TARGET LLVMInitializeLoongArchTarget
 #else
 #error "unknown architecture"
 #endif
@@ -190,6 +204,8 @@
 #define LLVM_NATIVE_TARGETINFO LLVMInitializePowerPCTargetInfo
 #elif defined(__riscv)
 #define LLVM_NATIVE_TARGETINFO LLVMInitializeRISCVTargetInfo
+#elif defined(__loongarch__)
+#define LLVM_NATIVE_TARGETINFO LLVMInitializeLoongArchTargetInfo
 #else
 #error "unknown architecture"
 #endif
@@ -209,6 +225,8 @@
 #define LLVM_NATIVE_TARGETMC LLVMInitializePowerPCTargetMC
 #elif defined(__riscv)
 #define LLVM_NATIVE_TARGETMC LLVMInitializeRISCVTargetMC
+#elif defined(__loongarch__)
+#define LLVM_NATIVE_TARGETMC LLVMInitializeLoongArchTargetMC
 #else
 #error "unknown architecture"
 #endif
-- 
2.45.2

